{% extends "base.html" %}

{% block page_title %}City Governance Intelligence{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Action Button -->
    <div class="flex justify-between items-end mb-8">
        <div>
            <h1 class="text-3xl font-black text-[#0F4C5C]">District Comparative Intelligence</h1>
            <p class="text-slate-500 mt-1">Cross-district risk ranking and vulnerability analysis.</p>
        </div>
        <a href="/reports/mayor-brief"
            class="bg-[#2ECC71] text-white px-8 py-4 rounded-2xl shadow-lg hover:scale-105 transition-all flex items-center gap-3">
            <i class="fas fa-file-invoice text-xl"></i>
            <span class="font-bold text-sm uppercase tracking-widest">Generate Mayor Briefing</span>
        </a>
    </div>

    <!-- District Risk Ranking Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="districtRanking">
        <!-- Rank Cards will be injected here -->
        <div
            class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex items-center justify-center animate-pulse h-32">
            <span class="text-slate-300 font-bold uppercase tracking-widest text-[10px]">Loading District
                Ranks...</span>
        </div>
    </div>

    <!-- Comparative Table -->
    <div class="bg-white rounded-[3rem] shadow-xl border border-slate-50 overflow-hidden">
        <div class="p-10 border-b border-slate-50 flex justify-between items-center">
            <div>
                <h3 class="text-xl font-bold text-slate-800">Live City Governance Matrix</h3>
                <p class="text-xs text-slate-400 font-medium">Real-time breakdown of district-level environmental
                    performance.</p>
            </div>
            <div class="px-4 py-2 bg-[#F8F9FA] rounded-xl border border-slate-100 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[10px] font-black text-slate-500 uppercase">Multi-Sensor Sync Active</span>
            </div>
        </div>
        <div class="overflow-x-auto p-10">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-slate-100">
                        <th class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">District Name
                        </th>
                        <th class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Live AQI</th>
                        <th class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Vulnerability
                        </th>
                        <th class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Primary Risk
                        </th>
                        <th class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Trend</th>
                        <th class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Action Status
                        </th>
                    </tr>
                </thead>
                <tbody id="districtMatrix">
                    <!-- Data Injected Here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Policy & Guidelines Section (NEW requested feature) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-[#0F4C5C] p-10 rounded-[3rem] shadow-2xl text-white relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="text-2xl font-black mb-6">Strategic Pollution Mitigation Guidelines</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center shrink-0">
                                <i class="fas fa-truck-moving text-emerald-400"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Traffic Diversion Protocols</h4>
                                <p class="text-[11px] text-teal-100/70 mt-1">Automated heavy-vehicle rerouting during
                                    peak AQI spikes (>200) in the Central Business District.</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center shrink-0">
                                <i class="fas fa-factory text-orange-400"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Industrial Output Modulation</h4>
                                <p class="text-[11px] text-teal-100/70 mt-1">Mandatory 30% reduction in smelting
                                    activities when atmospheric dispersion falls below 2.0.</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center shrink-0">
                                <i class="fas fa-tree text-emerald-300"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Green Lung Expansion</h4>
                                <p class="text-[11px] text-teal-100/70 mt-1">Accelerated deployment of vertical forestry
                                    in Vulnerability Ranks 1 & 2 to act as particulate filters.</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center shrink-0">
                                <i class="fas fa-broadcast-tower text-blue-300"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Citizen Health Broadcasts</h4>
                                <p class="text-[11px] text-teal-100/70 mt-1">Real-time SMS alerts to elderly and
                                    pediatric citizens when local AQI variance exceeds 15% hourly.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="absolute -right-20 -bottom-20 w-80 h-80 bg-white/5 rounded-full blur-3xl"></div>
        </div>

        <div class="bg-white p-10 rounded-[3rem] shadow-xl border border-slate-50">
            <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Vulnerability Intelligence</h3>
            <div id="vulnerabilityBox" class="space-y-6">
                <!-- Most vulnerable district analysis -->
                <div class="animate-pulse flex flex-col gap-4">
                    <div class="h-4 bg-slate-100 rounded w-full"></div>
                    <div class="h-10 bg-slate-100 rounded w-full"></div>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-slate-50">
                <p class="text-[10px] text-slate-400 leading-relaxed italic">
                    "System identifies <strong>Industrial North</strong> as the most vulnerable zone this hour due to
                    1.3x AQI amplification over city baseline."
                </p>
            </div>
        </div>
    </div>
    <!-- Zone-wise District Directory (NEW requested feature) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-12 pb-10">
        <div
            class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm hover:border-emerald-200 transition-all group">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600">
                    <i class="fas fa-building text-sm"></i>
                </div>
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">CBD Districts</h4>
            </div>
            <ul class="space-y-3">
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-700">
                    <div class="w-1 h-1 rounded-full bg-emerald-400"></div>Mumbai
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-700">
                    <div class="w-1 h-1 rounded-full bg-emerald-400"></div>Bengaluru
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-700">
                    <div class="w-1 h-1 rounded-full bg-emerald-400"></div>New Delhi
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-700">
                    <div class="w-1 h-1 rounded-full bg-emerald-400"></div>Hyderabad
                </li>
            </ul>
        </div>

        <div
            class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm hover:border-orange-200 transition-all group">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600">
                    <i class="fas fa-industry text-sm"></i>
                </div>
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Industrial North</h4>
            </div>
            <ul class="space-y-3">
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-orange-700">
                    <div class="w-1 h-1 rounded-full bg-orange-400"></div>Ahmedabad
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-orange-700">
                    <div class="w-1 h-1 rounded-full bg-orange-400"></div>Kanpur
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-orange-700">
                    <div class="w-1 h-1 rounded-full bg-orange-400"></div>Surat
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-orange-700">
                    <div class="w-1 h-1 rounded-full bg-orange-400"></div>Ludhiana
                </li>
            </ul>
        </div>

        <div
            class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm hover:border-blue-200 transition-all group">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                    <i class="fas fa-home text-sm"></i>
                </div>
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Residential South</h4>
            </div>
            <ul class="space-y-3">
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-blue-700">
                    <div class="w-1 h-1 rounded-full bg-blue-400"></div>Chennai
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-blue-700">
                    <div class="w-1 h-1 rounded-full bg-blue-400"></div>Pune
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-blue-700">
                    <div class="w-1 h-1 rounded-full bg-blue-400"></div>Jaipur
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-blue-700">
                    <div class="w-1 h-1 rounded-full bg-blue-400"></div>Kochi
                </li>
            </ul>
        </div>

        <div
            class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm hover:border-emerald-300 transition-all group">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-700">
                    <i class="fas fa-leaf text-sm"></i>
                </div>
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Green Belt West</h4>
            </div>
            <ul class="space-y-3">
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-900">
                    <div class="w-1 h-1 rounded-full bg-emerald-500"></div>Mysuru
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-900">
                    <div class="w-1 h-1 rounded-full bg-emerald-500"></div>Shimla
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-900">
                    <div class="w-1 h-1 rounded-full bg-emerald-500"></div>Thiruvananthapuram
                </li>
                <li class="text-[11px] font-bold text-slate-500 flex items-center gap-2 group-hover:text-emerald-900">
                    <div class="w-1 h-1 rounded-full bg-emerald-500"></div>Dehradun
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    async function updateGovernance() {
        try {
            const resp = await fetch('/api/districts');
            const districts = await resp.json();

            // 1. Update Matrix Table
            const matrix = document.getElementById('districtMatrix');
            matrix.innerHTML = districts.map(d => `
                <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-colors">
                    <td class="py-6 font-bold text-slate-700">${d.name}</td>
                    <td class="py-6 font-black text-[#0F4C5C]">${Math.round(d.aqi)}</td>
                    <td class="py-6">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${d.vulnerability === 'Critical' ? 'bg-red-100 text-red-600' :
                    d.vulnerability === 'High' ? 'bg-orange-100 text-orange-600' :
                        d.vulnerability === 'Low' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'
                }">${d.vulnerability}</span>
                    </td>
                    <td class="py-6 text-slate-500 font-medium">${d.risk}</td>
                    <td class="py-6">
                        <div class="flex items-center gap-2">
                            <i class="fas ${d.trend === 'Rising' ? 'fa-arrow-trend-up text-red-500' : 'fa-arrow-trend-down text-emerald-500'}"></i>
                            <span class="text-xs font-bold text-slate-600">${d.trend}</span>
                        </div>
                    </td>
                    <td class="py-6 font-black ${d.aqi > 150 ? 'text-red-500' : 'text-emerald-500'}">
                        ${d.aqi > 150 ? 'ACTION REQ' : 'STABLE'}
                    </td>
                </tr>
            `).join('');

            // 2. Update Ranking Cards
            const ranking = document.getElementById('districtRanking');
            ranking.innerHTML = districts.map((d, i) => `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 relative group overflow-hidden">
                    <span class="absolute -right-2 -top-2 text-6xl font-black text-slate-50/50 z-0 opacity-20">${i + 1}</span>
                    <div class="relative z-10">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Rank ${i + 1}</h3>
                        <p class="font-bold text-slate-800 text-xs truncate mb-1">${d.name}</p>
                        <div class="flex items-end gap-2">
                            <span class="text-2xl font-black text-[#0F4C5C]">${Math.round(d.aqi)}</span>
                            <span class="text-[8px] font-bold text-slate-400 uppercase mb-1">AQI Baseline</span>
                        </div>
                    </div>
                </div>
            `).sort((a, b) => b.aqi - a.aqi).join('');

            // 3. Update Vulnerability Box
            const vBox = document.getElementById('vulnerabilityBox');
            const mostVulnerable = districts.reduce((prev, current) => (prev.aqi > current.aqi) ? prev : current);
            vBox.innerHTML = `
                <div class="p-6 bg-red-50 border border-red-100 rounded-3xl">
                    <div class="flex justify-between mb-4">
                        <span class="text-[10px] font-black text-red-800 uppercase">Critical Zone</span>
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <p class="text-lg font-black text-red-900">${mostVulnerable.name}</p>
                    <p class="text-[11px] text-red-700 mt-2">Current risk: <strong>${mostVulnerable.risk}</strong> impact.</p>
                </div>
            `;

        } catch (e) { console.error(e); }
    }

    setInterval(updateGovernance, 3000);
    window.addEventListener('load', updateGovernance);
</script>
{% endblock %}