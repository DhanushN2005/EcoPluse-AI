{% extends "base.html" %}
{% block page_title %}Climate Copilot{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto flex flex-col h-[75vh]">
    <div id="chat-window"
        class="flex-1 bg-white rounded-[3rem] shadow-sm border border-slate-100 p-8 overflow-y-auto mb-6 space-y-6 scrollbar-hide">
        <!-- AI Welcome -->
        <div class="flex gap-4">
            <div class="w-10 h-10 rounded-full bg-[#0F4C5C] flex items-center justify-center shrink-0">
                <span class="text-white text-sm">AI</span>
            </div>
            <div class="bg-slate-50 p-6 rounded-3xl rounded-tl-none border border-slate-100 max-w-[80%]">
                <p class="text-sm leading-relaxed">Hello, I am your Climate Copilot. I analyze real-time environmental
                    data to provide scientific insights and safety recommendations. How can I assist you today?</p>
            </div>
        </div>
    </div>

    <div class="bg-white p-4 rounded-[2.5rem] shadow-xl border border-slate-100 flex items-center gap-4 px-6">
        <input id="user-input" type="text" placeholder="Ask about air quality trends or safety protocols..."
            class="flex-1 bg-transparent border-none outline-none text-sm py-4">
        <button id="ask-btn"
            class="bg-[#2ECC71] text-white px-8 py-3 rounded-2xl font-bold text-sm hover:bg-[#27ae60] transition-all flex items-center gap-2">
            Ask AI
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const askBtn = document.getElementById('ask-btn');

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = "flex gap-4 " + (role === 'user' ? 'justify-end' : '');

        const content = `
            ${role === 'ai' ? '<div class="w-10 h-10 rounded-full bg-[#0F4C5C] flex items-center justify-center shrink-0"><span class="text-white text-sm">AI</span></div>' : ''}
            <div class="${role === 'user' ? 'bg-[#0F4C5C] text-white' : 'bg-slate-50 text-slate-800'} p-6 rounded-3xl ${role === 'ai' ? 'rounded-tl-none' : 'rounded-tr-none'} border border-slate-100 max-w-[80%]">
                <div class="text-sm leading-relaxed whitespace-pre-wrap">${text}</div>
            </div>
            ${role === 'user' ? '<div class="w-10 h-10 rounded-full bg-[#2ECC71] flex items-center justify-center shrink-0"><span class="text-white text-sm">ME</span></div>' : ''}
        `;

        div.innerHTML = content;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    askBtn.addEventListener('click', async () => {
        const query = userInput.value;
        if (!query) return;

        appendMessage('user', query);
        userInput.value = '';

        // Show loading state
        const loadingDiv = document.createElement('div');
        loadingDiv.className = "text-xs italic text-slate-400 ml-14";
        loadingDiv.innerText = "Copilot is analyzing data...";
        chatWindow.appendChild(loadingDiv);

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const data = await response.json();

            chatWindow.removeChild(loadingDiv);
            appendMessage('ai', data.response || "I encountered an error processing your request.");
        } catch (err) {
            chatWindow.removeChild(loadingDiv);
            appendMessage('ai', "Error connecting to backend.");
        }
    });

    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') askBtn.click();
    });
</script>
{% endblock %}